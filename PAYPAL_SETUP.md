# PayPal Integration Setup Guide

## Quick Setup (5 minutes)

### 1. Create PayPal Developer Account
1. Go to https://developer.paypal.com
2. Sign in or create account
3. Navigate to **Dashboard â†’ My Apps & Credentials**

### 2. Create App (Sandbox Testing)
1. Under **Sandbox**, click **Create App**
2. Enter App Name: "Lumi Billing"
3. Select App Type: **Merchant**
4. Click **Create App**

### 3. Get Credentials
Copy these from your app page:
- **Client ID** (starts with `A...`)
- **Secret** (click "Show" to reveal)

### 4. Configure Environment Variables
Add to your `.env` file:
```env
PAYPAL_CLIENT_ID=AYour-Client-ID-Here
PAYPAL_CLIENT_SECRET=Your-Secret-Here
PAYPAL_WEBHOOK_ID=your-webhook-id
PAYPAL_MODE=sandbox
```

### 5. Setup Webhooks
1. In your app page, scroll to **Webhooks**
2. Click **Add Webhook**
3. Enter Webhook URL: `https://yourdomain.com/api/paypal/webhook`
4. Select events:
   - âœ… `Payment capture completed`
   - âœ… `Payment capture denied`
   - âœ… `Payment capture refunded`
5. Click **Save**
6. Copy the **Webhook ID** and add to `.env` as `PAYPAL_WEBHOOK_ID`

### 6. Test Integration
1. Restart your dev server: `npm run dev`
2. Navigate to an unpaid invoice
3. Click "Pay with PayPal"
4. You'll be redirected to PayPal sandbox
5. Use test account credentials (available in PayPal Dashboard)
6. Complete payment
7. Verify invoice status updates to "PAID"

---

## Sandbox Test Accounts

PayPal provides test accounts for development:
1. Go to **Dashboard â†’ Sandbox â†’ Accounts**
2. Use **Personal Account** credentials to test payments
3. Use **Business Account** to receive payments

**Default Test Credentials**:
- Email: Generated by PayPal (e.g., `sb-buyer@personal.example.com`)
- Password: Available in Sandbox Accounts section

---

## Production Setup

### When Ready for Live Payments:

1. **Get Live Credentials**:
   - Switch to **Live** tab in Dashboard
   - Create new live app
   - Copy Live Client ID and Secret

2. **Update Environment Variables**:
```env
PAYPAL_CLIENT_ID=Live-Client-ID
PAYPAL_CLIENT_SECRET=Live-Secret
PAYPAL_WEBHOOK_ID=Live-Webhook-ID
PAYPAL_MODE=live
```

3. **Configure Live Webhooks**:
   - Same steps as sandbox
   - Use production domain URL
   - Ensure HTTPS is enabled

4. **Test Live Integration**:
   - Small test payment
   - Verify webhook delivery
   - Check invoice status
   - Review audit logs

---

## How It Works

### Payment Flow:
```
1. User clicks "Pay with PayPal" on invoice
   â†“
2. POST /api/paypal/checkout
   - Creates PayPal order
   - Converts invoice items to PayPal line items
   - Returns approval URL
   â†“
3. User redirected to PayPal
   - Reviews order
   - Logs into PayPal
   - Approves payment
   â†“
4. PayPal redirects to /api/paypal/capture
   - Captures approved payment
   - Updates invoice status
   - Creates audit log
   â†“
5. User redirected to /client/invoices?success=true
```

### Webhook Flow:
```
1. PayPal sends event to /api/paypal/webhook
   â†“
2. Webhook handler verifies signature
   â†“
3. Processes event based on type:
   - PAYMENT.CAPTURE.COMPLETED â†’ Mark paid
   - PAYMENT.CAPTURE.REFUNDED â†’ Mark refunded
   - PAYMENT.CAPTURE.DENIED â†’ Log denial
   â†“
4. Updates database
   â†“
5. Creates audit log
   â†“
6. Returns 200 OK to PayPal
```

---

## Features Included

âœ… **Complete Payment Processing**
- Order creation with invoice items
- Line item breakdown (subtotal, tax)
- Approval and capture flow
- Automatic invoice updates

âœ… **Webhook Handling**
- Payment completion
- Refund detection
- Denial tracking
- Signature verification

âœ… **Audit Trail**
- All payment events logged
- User tracking
- IP address capture
- Timestamp recording

âœ… **Error Handling**
- API errors caught and logged
- User-friendly error messages
- Retry logic for webhooks
- Validation checks

âœ… **Security**
- Environment variable credentials
- Webhook signature verification
- HTTPS required for live mode
- No sensitive data exposure

---

## Troubleshooting

### "Webhook not firing"
**Solution**: Ensure webhook URL is publicly accessible and uses HTTPS

### "Payment not captured"
**Solution**: Check return URL is correct in checkout creation

### "Invalid credentials"
**Solution**: Verify `PAYPAL_CLIENT_ID` and `PAYPAL_CLIENT_SECRET` are correct

### "Sandbox vs Live mismatch"
**Solution**: Ensure `PAYPAL_MODE` matches your credentials (sandbox/live)

### "Invoice not updating"
**Solution**: Check audit logs at `/admin/audit-logs` for errors

---

## Testing Checklist

Before going live, test:
- [ ] Create PayPal order from invoice
- [ ] Complete payment with sandbox account
- [ ] Verify invoice status updates to PAID
- [ ] Check audit log entry created
- [ ] Test payment denial scenario
- [ ] Simulate refund via PayPal Dashboard
- [ ] Verify webhook receives all events
- [ ] Test with different invoice amounts
- [ ] Check tax calculation in PayPal
- [ ] Verify line items display correctly

---

## Support Resources

- **PayPal Developer Docs**: https://developer.paypal.com/docs
- **Orders API**: https://developer.paypal.com/docs/api/orders/v2
- **Webhooks Guide**: https://developer.paypal.com/docs/api-basics/notifications/webhooks
- **Sandbox Testing**: https://developer.paypal.com/docs/api-basics/sandbox

---

## Environment Variable Reference

```env
# Sandbox Mode (Development)
PAYPAL_CLIENT_ID=AYour-Sandbox-Client-ID
PAYPAL_CLIENT_SECRET=Your-Sandbox-Secret
PAYPAL_WEBHOOK_ID=Your-Sandbox-Webhook-ID
PAYPAL_MODE=sandbox

# Live Mode (Production)
PAYPAL_CLIENT_ID=Your-Live-Client-ID
PAYPAL_CLIENT_SECRET=Your-Live-Secret
PAYPAL_WEBHOOK_ID=Your-Live-Webhook-ID
PAYPAL_MODE=live
```

---

## API Endpoints

- **POST** `/api/paypal/checkout` - Create PayPal order
- **GET** `/api/paypal/capture` - Capture approved payment
- **POST** `/api/paypal/webhook` - Receive PayPal events

All endpoints include:
- Authentication checks
- Error handling
- Audit logging
- Database updates

---

## Integration Benefits

âœ… **No Additional Dependencies**
- Uses native `fetch()` API
- No PayPal SDK required
- Smaller bundle size
- Faster page loads

âœ… **Modern Architecture**
- REST API v2 (latest)
- JSON payloads
- OAuth 2.0 authentication
- Webhook-based updates

âœ… **Production Ready**
- Comprehensive error handling
- Transaction logging
- Security best practices
- Scalable architecture

---

**Your PayPal integration is ready to use!** ðŸŽ‰

Just configure the environment variables and start accepting payments.
