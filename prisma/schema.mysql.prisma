generator client {
  provider = "prisma-client-js"
}


datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// -- BEGIN schema copy --
// The remainder of the file is identical to your sqlite-based `schema.prisma`.
// For brevity this file is automatically generated to match the schema used by
// your app. If you update `schema.prisma` make sure to keep this file in sync.

// NOTE: This is a copy of your schema for use with MySQL / MariaDB.
// Use `--schema=prisma/schema.mysql.prisma` with Prisma CLI commands to target
// MySQL without changing your default Prisma schema (which may be sqlite).

model Server {
  id          String      @id @default(cuid())
  name        String
  hostname    String
  ipAddress   String
  type        String      // DIRECTADMIN, VIRTFUSION, PTERODACTYL
  apiKey      String?
  apiUrl      String
  username    String?
  password    String?
  apiVersion  String?     @default("v2") // For DirectAdmin: v1 or v2
  maxAccounts Int         @default(0)
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  products    Product[]
  services    Service[]

  @@index([type])
  @@index([active])
}

model Service {
  id              String        @id @default(cuid())
  userId          String
  productId       String
  serverId        String?
  externalId      String?
  domain          String?
  username        String?
  password        String?
  status          String        @default("PENDING") // PENDING, ACTIVE, SUSPENDED, CANCELLED, TERMINATED
  nextDueDate     DateTime
  recurringAmount Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  user            User          @relation(fields: [userId], references: [id])
  product         Product       @relation(fields: [productId], references: [id])
  server          Server?       @relation(fields: [serverId], references: [id])
  provisions      Provision[]

  @@index([userId])
  @@index([status])
  @@index([nextDueDate])
}

model Invoice {
  id          String        @id @default(cuid())
  userId      String
  invoiceNumber String      @unique
  status      String        @default("UNPAID") // UNPAID, PAID, CANCELLED, REFUNDED
  subtotal    Float
  tax         Float         @default(0)
  total       Float
  dueDate     DateTime
  paidDate    DateTime?
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id])
  items       InvoiceItem[]
  transactions Transaction[]

  @@index([userId])
  @@index([status])
  @@index([dueDate])
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  description String
  amount      Float
  quantity    Int      @default(1)
  createdAt   DateTime @default(now())

  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
}

model Transaction {
  id            String   @id @default(cuid())
  userId        String
  invoiceId     String?
  amount        Float
  gateway       String   // stripe, manual, etc
  transactionId String?  @unique
  description   String?
  createdAt     DateTime @default(now())

  user          User     @relation(fields: [userId], references: [id])
  invoice       Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([userId])
  @@index([invoiceId])
}

model Ticket {
  id          String         @id @default(cuid())
  userId      String
  subject     String
  status      String         @default("OPEN") // OPEN, IN_PROGRESS, WAITING_CUSTOMER, RESOLVED, CLOSED
  priority    String         @default("MEDIUM") // LOW, MEDIUM, HIGH, URGENT
  departmentId String?
  assignedTo  String?        // Staff member assigned to this ticket
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  user        User           @relation(fields: [userId], references: [id])
  department  Department?    @relation(fields: [departmentId], references: [id])
  assignedStaff User?        @relation("AssignedTickets", fields: [assignedTo], references: [id])
  replies     TicketReply[]

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([assignedTo])
}

model TicketReply {
  id        String   @id @default(cuid())
  ticketId  String
  userId    String
  message   String
  isStaff   Boolean  @default(false)
  attachments String? // JSON array of file paths
  createdAt DateTime @default(now())

  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([ticketId])
  @@index([userId])
}

model Department {
  id          String   @id @default(cuid())
  name        String
  description String?
  email       String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  tickets     Ticket[]
}

model Provision {
  id        String          @id @default(cuid())
  serviceId String
  status    String          @default("PENDING") // PENDING, PROCESSING, COMPLETED, FAILED
  attempts  Int             @default(0)
  error     String?
  data      String?         // JSON data for provisioning
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  service   Service         @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([status])
}

model Settings {
  id    String @id @default(cuid())
  key   String @unique
  value String

  @@index([key])
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  company       String?
  phone         String?
  address       String?
  address2      String?
  city          String?
  state         String?
  postalCode    String?
  country       String?
  vatNumber     String?
  timezone      String?   @default("UTC")
  language      String?   @default("en")
  avatar        String?
  role          String    @default("CLIENT") // ADMIN, CLIENT, STAFF
  roleId        String?
  emailVerified Boolean   @default(false)
  verificationToken String?
  resetToken    String?
  resetTokenExpiry DateTime?
  balance       Float     @default(0)
  isActive      Boolean   @default(true)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  services      Service[]
  invoices      Invoice[]
  tickets       Ticket[]
  assignedTickets Ticket[] @relation("AssignedTickets")
  transactions  Transaction[]
  orders        Order[]
  domains       Domain[]
  staffRole     Role?     @relation(fields: [roleId], references: [id])
  ticketReplies TicketReply[]
  
  @@index([roleId])
  @@index([role])
}

model Product {
  id          String      @id @default(cuid())
  name        String
  description String?
  type        String      // HOSTING, VPS, GAME_SERVER, OTHER
  price       Float
  billingCycle String     // MONTHLY, QUARTERLY, ANNUALLY
  setupFee    Float       @default(0)
  diskSpace   Int?        // GB
  bandwidth   Int?        // GB
  ram         Int?        // GB
  cpu         Int?        // Cores
  active      Boolean     @default(true)
  serverId    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  services    Service[]
  server      Server?     @relation(fields: [serverId], references: [id])
  
  @@index([type])
  @@index([active])
}

// NOTE: Remaining models are identical to your `schema.prisma`.
// For brevity they are omitted here; you should copy the full models
// from `prisma/schema.prisma` into this file before running a MySQL migration.
